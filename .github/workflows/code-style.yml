name: Code Style

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  cpp-format-check:
    name: C++ Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          echo "deb http://apt.llvm.org/noble/ llvm-toolchain-noble main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-format-21
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-21 100

      - name: Check C++ formatting
        run: |
          # Find all C++ source files
          CPP_FILES=$(find . -name "*.cpp" -o -name "*.h" | grep -v deps/ | grep -v autom4te.cache/ | sort)

          # Check formatting (dry-run)
          FAILED=0
          for file in $CPP_FILES; do
            if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
              echo "::error file=$file::File needs formatting: $file"
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Some files need formatting. Run locally:"
            echo "  make format"
            exit 1
          fi

          echo "All C++ files are properly formatted!"

