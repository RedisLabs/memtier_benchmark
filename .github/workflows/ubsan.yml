name: UBSan (UndefinedBehaviorSanitizer)

# Undefined behavior detection using UndefinedBehaviorSanitizer
# This workflow builds memtier_benchmark with UBSan enabled and runs
# the full test suite to detect undefined behavior issues.

on:
  push:
    branches:
      - master
      - main
      - '[0-9]*.[0-9]*'
      - '![0-9]*.[0-9]*-*'
  pull_request:
    branches:
      - master
      - main
      - '[0-9]*.[0-9]*'
      - '![0-9]*.[0-9]*-*'

jobs:
  build-ubsan:
    runs-on: ubuntu-latest
    name: Build with UBSan
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get -qq update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          pkg-config \
          libevent-dev \
          zlib1g-dev \
          libssl-dev

    - name: Build with UBSan
      run: |
        autoreconf -ivf
        ./configure --enable-ubsan
        make -j

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: memtier-ubsan-build
        path: |
          memtier_benchmark
        retention-days: 1

  test-ubsan:
    needs: build-ubsan
    strategy:
      fail-fast: false
      matrix:
        test-config:
          - name: "Single Endpoint: TCP Plaintext"
            env: { OSS_STANDALONE: "1", OSS_CLUSTER: "0", TLS: "0", VERBOSE: "1", UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1" }
            tls: false
          - name: "Single Endpoint: TCP TLS"
            env: { OSS_STANDALONE: "1", OSS_CLUSTER: "0", TLS: "1", VERBOSE: "1", UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1" }
            tls: true
          - name: "OSS TCP TLS v1.2"
            env: { OSS_STANDALONE: "1", OSS_CLUSTER: "0", TLS: "1", TLS_PROTOCOLS: "TLSv1.2", VERBOSE: "1", UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1" }
            tls: true
          - name: "OSS TCP TLS v1.3"
            env: { OSS_STANDALONE: "1", OSS_CLUSTER: "0", TLS: "1", TLS_PROTOCOLS: "TLSv1.3", VERBOSE: "1", UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1" }
            tls: true
          - name: "OSS-CLUSTER API: TCP Plaintext"
            env: { OSS_STANDALONE: "0", OSS_CLUSTER: "1", VERBOSE: "1", UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1" }
            tls: false
          - name: "OSS-CLUSTER API: TCP TLS"
            env: { OSS_STANDALONE: "0", OSS_CLUSTER: "1", TLS: "1", VERBOSE: "1", UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1" }
            tls: true
    runs-on: ubuntu-latest
    name: UBSan ${{ matrix.test-config.name }}
    steps:
    - uses: actions/checkout@v4

    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: memtier-ubsan-build

    - name: Restore executable permissions
      run: chmod +x memtier_benchmark

    - name: Install dependencies
      run: |
        sudo apt-get -qq update
        sudo apt-get install -y pkg-config libevent-dev libssl-dev

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'
        architecture: x64

    - name: Install Python test dependencies
      run: pip install -r ./tests/test_requirements.txt

    - name: Install Redis
      run: |
        curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list
        sudo apt-get -qq update
        sudo apt-get install redis
        sudo service redis-server stop

    - name: Increase connection limit
      run: |
        sudo sysctl -w net.ipv4.tcp_fin_timeout=10
        sudo sysctl -w net.ipv4.tcp_tw_reuse=1
        ulimit -n 40960

    - name: Generate TLS test certificates
      if: matrix.test-config.tls
      run: ./tests/gen-test-certs.sh

    - name: Run tests
      timeout-minutes: 10
      env: ${{ matrix.test-config.env }}
      run: |
        ./tests/run_tests.sh

